pipeline {
  agent any

  environment {
    DOCKERHUB_REPO = 'pavanyennu'
    IMAGE_NAME_WEB = "${DOCKERHUB_REPO}/web-frontend"
    IMAGE_NAME_PRODUCT = "${DOCKERHUB_REPO}/product-service"
    IMAGE_NAME_ORDER = "${DOCKERHUB_REPO}/order-service"

    CHART_DIR = 'charts/bluegreen-app'
    NAMESPACE = 'myns'
    RELEASE = 'myapp'

    SONAR_HOST = 'https://sonarcloud.io'
    PROJECT_KEY_WEB = 'web-frontend'
    PROJECT_KEY_PRODUCT = 'product-service'
    PROJECT_KEY_ORDER = 'order-service'
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Maven Build & SonarCloud') {
  parallel {
    stage('Build Web') {
      steps {
        dir('services/web-frontend') {
          script {
            // Fetch secrets from GSM
            SONAR_TOKEN = sh(script: 'gcloud secrets versions access latest --secret="sonar-token"', returnStdout: true).trim()
            SONAR_ORG = sh(script: 'gcloud secrets versions access latest --secret="sonar-organization"', returnStdout: true).trim()

            sh """
              mvn -B -DskipTests package sonar:sonar \
                -Dsonar.login=${SONAR_TOKEN} \
                -Dsonar.host.url=https://sonarcloud.io \
                -Dsonar.projectKey=projecty_web-frontend \
                -Dsonar.organization=${SONAR_ORG}
            

            """
          }
        }
      }
    }

    stage('Build Product') {
      steps {
        dir('services/product-service') {
          script {
            SONAR_TOKEN = sh(script: 'gcloud secrets versions access latest --secret="sonar-token"', returnStdout: true).trim()
            SONAR_ORG = sh(script: 'gcloud secrets versions access latest --secret="sonar-organization"', returnStdout: true).trim()

            sh """
              mvn -B -DskipTests package sonar:sonar \
                -Dsonar.login=${SONAR_TOKEN} \
                -Dsonar.host.url=https://sonarcloud.io \
                -Dsonar.projectKey=projecty_product-services \
                -Dsonar.organization=${SONAR_ORG}
                

            """
          }
        }
      }
    }

    stage('Build Order') {
      steps {
        dir('services/order-service') {
          script {
            SONAR_TOKEN = sh(script: 'gcloud secrets versions access latest --secret="sonar-token"', returnStdout: true).trim()
            SONAR_ORG = sh(script: 'gcloud secrets versions access latest --secret="sonar-organization"', returnStdout: true).trim()

            sh """
              mvn -B -DskipTests package sonar:sonar \
                -Dsonar.login=${SONAR_TOKEN} \
                -Dsonar.host.url=https://sonarcloud.io \
                -Dsonar.projectKey=projecty_order-service \
                -Dsonar.organization=${SONAR_ORG}
                

            """
          }
        }
      }
    }
  }
}

    stage('Build & Push Docker Images') {
      steps {
        script {
          env.TAG = "${env.BUILD_NUMBER}"
          env.IMAGE_WEB = "${IMAGE_NAME_WEB}:${env.TAG}"
          env.IMAGE_PRODUCT = "${IMAGE_NAME_PRODUCT}:${env.TAG}"
          env.IMAGE_ORDER = "${IMAGE_NAME_ORDER}:${env.TAG}"

          // Fetch Docker Hub credentials from GSM
          DH_USER = sh(script: 'gcloud secrets versions access latest --secret="docker-username"', returnStdout: true).trim()
          DH_PASS = sh(script: 'gcloud secrets versions access latest --secret="docker-password"', returnStdout: true).trim()
        }

        sh """
          docker build -t ${IMAGE_WEB} ./services/web-frontend
          docker build -t ${IMAGE_PRODUCT} ./services/product-service
          docker build -t ${IMAGE_ORDER} ./services/order-service

          echo ${DH_PASS} | docker login -u ${DH_USER} --password-stdin
          docker push ${IMAGE_WEB}
          docker push ${IMAGE_PRODUCT}
          docker push ${IMAGE_ORDER}
          docker logout
        """
      }
    }

stage('Update Helm values & Deploy') {
  steps {
    script {
      // 1. Fetch GCP service account key from Secret Manager
      GCP_SA_KEY_JSON = sh(
        script: 'gcloud secrets versions access latest --secret="jenkins-gcp-sa-key"',
        returnStdout: true
      ).trim()

      // 2. Write it to a temporary file
      writeFile file: 'gcp-key.json', text: GCP_SA_KEY_JSON

      // 3. Activate service account
      sh 'gcloud auth activate-service-account --key-file=gcp-key.json'

      // 4. Set the GKE cluster context
      sh '''
        gcloud container clusters get-credentials autopilot-cluster --region europe-central2 --project pavan-477919
      '''

      // 5. Ensure the update script is executable
      sh 'chmod +x jenkins/scripts/update-helm-values.sh'

      // 6. Update Helm values with latest images
      sh "./jenkins/scripts/update-helm-values.sh ${IMAGE_WEB} ${IMAGE_PRODUCT} ${IMAGE_ORDER}"

      // 7. Deploy with Helm
      sh "helm upgrade ${RELEASE} ${CHART_DIR} -n ${NAMESPACE} --install --reuse-values --wait --timeout 5m"
    }
  }
}


    stage('Smoke Test') {
      steps {
        sh """
          kubectl -n ${NAMESPACE} rollout status deployment/${RELEASE}-web-green --timeout=180s
          POD=\$(kubectl -n ${NAMESPACE} get pods -l app.kubernetes.io/name=web-frontend,color=green -o jsonpath='{.items[0].metadata.name}')
          kubectl -n ${NAMESPACE} port-forward \$POD 8081:8080 >/tmp/pf.log 2>&1 &
          PF_PID=\$!
          sleep 2
          if ! curl --fail --max-time 10 http://127.0.0.1:8081/health ; then
            echo "Smoke test failed"
            kill \$PF_PID || true
            exit 1
          fi
          kill \$PF_PID || true
        """
      }
    }

    stage('Cutover to Green') {
      steps {
        sh "helm upgrade ${RELEASE} ${CHART_DIR} -n ${NAMESPACE} --install --set activeColor=green --reuse-values --wait --timeout 2m"
      }
    }

    stage('Post Cutover Validation') {
      steps {
        sh "kubectl -n ${NAMESPACE} get svc,deployment -l app.kubernetes.io/name=web-frontend"
      }
    }
  }

  post {
    failure {
      echo 'Failure: pipeline will not change activeColor â€” traffic remains on last active color'
    }
  }
}
